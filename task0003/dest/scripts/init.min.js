require(["util"],function(e){function t(e,t,a){this.title=e,this.date=t,this.main=a,this.done=!1}function a(e){this.name=e,this.tasks=[],this.addTask=function(e){var t=e.title,a=M.some(function(e){return e.title===t});return a===!1?(this.tasks.push(e),this.tasks.sort(E),M.push(e),M.sort(E),!0):!1},this.getTask=function(e){var t=this.tasks.filter(function(t){return t.title===e})[0];return void 0!==t?t:null},this.getTasksByStatus=function(e){var t=[];switch(e){case void 0:t=this.tasks;break;case"undone":t=this.tasks.filter(function(e){return e.done===!1});break;case"done":t=this.tasks.filter(function(e){return e.done===!0})}return t.sort(E)},this.getTasksByDate=function(e){return this.tasks.filter(function(t){return t.date===e})}}function n(e){var t=e.name,a=L.some(function(e){return e.name===t});return a===!1?(L.push(e),!0):!1}function i(e){var t=L.filter(function(t){return t.name===e})[0];return void 0!==t?t:null}function s(){var e=f("#category .active").getElementsByClassName("name")[0].innerHTML;return"所有任务"===e?M:i(e).tasks}function r(){var e=f(".tasklist .active");if(null!==e){var t=e.innerHTML;return M.filter(function(e){return e.title===t})[0]}}function l(){var e='<li class="cate all"><span class="name cate">所有任务</span><span class="undone cate">0</span></li>',t=0;for(var a in L){var n=L[a],i=n.getTasksByStatus("undone").length;e+='<li class="cate"><span class="name cate">'+n.name+'</span><span class="undone cate">'+i+'</span><img class="remove" src="img/icon-minus.png"></li>',t+=i}var s=f(".catelist");s.innerHTML=e,p(s.childNodes[1],"active"),p(s.childNodes[1],"default"),f(".all .undone").innerHTML=t}function c(e){var t=s().filter(function(t){switch(e){case void 0:return!0;case"undone":return t.done===!1;case"done":return t.done===!0}});if(void 0===t[0])f(".tasklist").innerHTML="";else{var a=y(t.map(function(e){return e.date})),n="";for(var i in a){var r=a[i];n+='<ul class="day"><h1 class="date">'+r+"</h1>";var l=t.filter(function(e){return e.date===r});for(var c in l){var o=l[c];n+='<li class="'+(o.done?"done ":"")+'task">'+o.title+"</li>"}n+="</ul>"}f(".tasklist").innerHTML=n,p(f(".tasklist").childNodes[0].childNodes[1],"active")}}function o(){var e=f(".tasklist .active");if(!e)return void C(H.contentOriginal,!1);var t=e.innerHTML,a=M.filter(function(e){return e.title===t})[0];void 0===a?C(H.contentOriginal,!1):(f("#content .title").innerHTML=a.title,f("#content .date").innerHTML=a.date,f("#content .main").innerHTML=a.main,a.done?p(f("#content .title"),"done"):k(f("#content .title"),"done"))}function d(e){var t;switch(!0){case h(e,"cate"):t=f(".catelist");break;case h(e,"task"):t=f(".tasklist");break;case h(e,"status"):t=f(".status-nav")}k(t.getElementsByClassName("active")[0],"active"),p(e,"active")}function u(e){var t=f(".catelist").getElementsByClassName("name");for(var a in t)if(t[a].innerHTML===e)return d(t[a].parentElement),!0;return!1}function v(e){var t=f(".tasklist").getElementsByClassName("task");for(var a in t)if(t[a].innerHTML===e)return d(t[a]),!0;return!1}function m(){var e=JSON.parse(localStorage.getItem("cateCache")),i=JSON.parse(localStorage.getItem("taskCache"));if(null===e){n(new a("默认分类")),n(new a("Work")),n(new a("Social")),n(new a("Trifle"));var s=new t("Date with my GF","2017-02-14","Wait. I ain't got none."),r=new t("Burger King","2017-04-01","Haven't had that for long.");L[0].addTask(s),L[0].addTask(r),s.done=!0;var l=new t("Finish task 0003","2016-04-30","Here is some content."),c=new t("Write report","2016-05-30","He he he.");L[1].addTask(l),L[1].addTask(c);var o=new t("Meet college pals","2016-05-30","And have some beer."),d=new t("Go to Jake's wedding","2016-10-01","How much should it cost me again?");L[2].addTask(o),L[2].addTask(d);var u=new t("Buy new shampoo","2017-02-14","That CLEAR one."),v=new t("Have a haircut","2016-06-01","To celebrate Children's day.");L[3].addTask(u),L[3].addTask(v)}else{var m=[];for(var g in i){var f=i[g],h=new t(f.title,f.date,f.main);h.done=f.done,m.push(h)}M=m;var k=[];for(var g in e){var p=e[g],y=p.tasks,T=new a(p.name);for(var g in y){var b=y[g].title;T.tasks.push(M.filter(function(e){return e.title===b})[0])}k.push(T)}L=k}}function g(){localStorage.setItem("cateCache",JSON.stringify(L)),localStorage.setItem("taskCache",JSON.stringify(M))}var f=e.$,h=e.hasClass,k=e.removeClass,p=e.addClass,y=e.uniqArray,T=e.trim,b=e.isValidDate,N=e.showInfo,w=e.resizeToWindowSize,C=e.replaceContentHtml,B=e.validateInput,E=e.dateDescending,H=function(){return{isEditing:!1,taskUnderEditing:null,archiveToEdit:"",archiveToDisplay:"",save:function(){var e=f("#content .title").innerHTML;this.archiveToDisplay=f("#content").innerHTML,this.archiveToEdit='<input type="input" class="title editable" placeholder="标题（22个字以内）" maxlength=22 value="'+e+'"><input type="input" class="date editable" placeholder="日期（yyyy-mm-dd格式）" maxlength=10 value="'+f("#content .date").innerHTML+'"><textarea class="main editable" placeholder="正文（500个字以内）" maxlength=500>'+f("#content .main").innerHTML+'</textarea><img class="save" src="img/icon-tick.png"><img class="cancel" src="img/icon-times.png">',this.taskUnderEditing=M.filter(function(t){return t.title===e})[0]},contentWhenAddingNew:'<input type="input" class="title editable" placeholder="标题（22个字以内）" maxlength=22><input type="input" class="date editable" placeholder="日期（yyyy-mm-dd格式）" maxlength=10><textarea class="main editable" placeholder="正文（500个字以内）" maxlength=500></textarea><img class="save" src="img/icon-tick.png"><img class="cancel" src="img/icon-times.png">',contentOriginal:'<h1 class="title">.</h1><h1 class="date">.</h1><p class="main">.</p><img class="mark" src="img/icon-done.png"><img class="edit" src="img/icon-pencil.png">'}}();f.delegateByClassName(".catelist","cate","mouseover",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;h(a,"all")||h(a,"default")||(a.getElementsByClassName("remove")[0].style.display="block")}),f.delegateByClassName(".catelist","cate","mouseout",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;h(a,"all")||h(a,"default")||(a.getElementsByClassName("remove")[0].style.display="none")}),f.delegateByClassName(".catelist","cate","click",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;d(a),d(f(".status.all")),c(),o()}),f.delegateByClassName(".catelist","remove","mouseover",function(e){var t=e.target;t.style.display="block"}),f.delegateByClassName(".catelist","remove","mouseout",function(e){var t=e.target;t.style.display="none"}),f.delegateByClassName(".catelist","remove","click",function(e){var t=e.target,a=t.previousElementSibling.previousElementSibling.innerHTML,n=confirm("将同时删除分类「"+a+"」下的所有任务。继续吗？");if(n===!0){var s=i(a),r=s.getTasksByStatus();for(var d in r)M.splice(M.indexOf(r[d]),1);L.splice(L.indexOf(s),1),l(),c(),o(),g()}}),f.click("#category .add",function(e){var t=prompt("请输入新分类的名字(8个字以内）。");if(null!==t){for(;""===t||t.length>8;)t=prompt("分类名称长度应在1至8个字之间。");return"所有任务"===t?void N("bad","不能给分类起这个名字。_(:зゝ∠)_"):n(new a(t))!==!0?void N("bad","已存在相同名称的分类。"):(N("good","添加分类成功。"),l(),d(f(".catelist").lastChild),c(),o(),g(),void 0)}}),f.delegateByClassName(".status-nav","status","click",function(e){var t=e.target;switch(d(t),!0){case h(t,"all"):c();break;case h(t,"undone"):c("undone");break;case h(t,"done"):c("done")}o()}),f.delegateByClassName(".tasklist","task","click",function(e){var t=e.target;d(t),o()}),f.click("#tasks .add",function(e){return h(f(".cate.all"),"active")?void N("bad","请先选择一个分类。"):(H.isEditing=!1,H.save(),void C(H.contentWhenAddingNew,!0))}),f.delegateByClassName("#content","mark","click",function(e){var t=r();if(void 0===t)return void N("bad","还没添加任务呢。");if(t.done===!0)return void N("bad","这个任务已经完成啦！");var a=t.title,n=f("#category .active").getElementsByClassName("name")[0].innerHTML,i=confirm("将「"+a+"」标记为「已完成」吗？");i===!0&&(t.done=!0,N("good","标记成功。"),g(),l(),u(n),c(),v(a),o())}),f.delegateByClassName("#content","edit","click",function(e){return void 0===r()?void N("bad","还没添加任务呢。"):(H.isEditing=!0,H.save(),void C(H.archiveToEdit,!0))}),f.delegateByClassName("#content","save","click",function(){var e=T(f(".title.editable").value),a=f(".date.editable").value,n=T(f(".main.editable").value);switch(H.isEditing){case!0:if(B(M,!1)){var s=H.taskUnderEditing;s.title=e,s.date=a,s.main=n,N("good","任务修改成功。"),C(H.contentOriginal,!1),c(),v(s.title),g()}break;case!1:if(B(M,!0)){var r=f("#category .active").getElementsByClassName("name")[0].innerHTML;i(r).addTask(new t(e,a,n)),N("good","成功添加任务。"),C(H.contentOriginal,!1),l(),u(r),c(),v(e),g()}}o()}),f.delegateByClassName("#content","cancel","click",function(){var e=confirm("确定退出编辑？");e===!0&&C(H.archiveToDisplay,!1)}),f.delegateByClassName("#content","editable","keyup",function(e){var t=e.target,a=t.value;switch(!0){case h(t,"title"):22===a.length&&N("bad","任务标题不能超过22个字。");break;case h(t,"date"):10!==a.length||b(a)||N("bad","任务日期不符合yyyy-mm-dd格式。");break;case h(t,"main"):500===a.length&&N("bad","任务正文不能超过500个字。")}}),window.onresize=function(){w()},f.click("#title .btn",function(){localStorage.clear(),N("bad","缓存已清理。")});var L=[],M=[];(function(){w(),m(),l(),c(),o()})()});