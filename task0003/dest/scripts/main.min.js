define(["util"],function(e){function t(e,t,a){this.title=e,this.date=t,this.main=a,this.done=!1}function a(e){this.name=e,this.tasks=[],this.addTask=function(e){var t=e.title,a=S.some(function(e){return e.title===t});return a===!1?(this.tasks.push(e),this.tasks.sort(H),S.push(e),S.sort(H),!0):!1},this.getTask=function(e){var t=this.tasks.filter(function(t){return t.title===e})[0];return void 0!==t?t:null},this.getTasksByStatus=function(e){var t=[];switch(e){case void 0:t=this.tasks;break;case"undone":t=this.tasks.filter(function(e){return e.done===!1});break;case"done":t=this.tasks.filter(function(e){return e.done===!0})}return t.sort(H)},this.getTasksByDate=function(e){return this.tasks.filter(function(t){return t.date===e})}}function n(e){var t=e.name,a=M.some(function(e){return e.name===t});return a===!1?(M.push(e),!0):!1}function i(e){var t=M.filter(function(t){return t.name===e})[0];return void 0!==t?t:null}function s(){var e=h("#category .active").getElementsByClassName("name")[0].innerHTML;return"所有任务"===e?S:i(e).tasks}function r(){var e=h(".tasklist .active");if(null!==e){var t=e.innerHTML;return S.filter(function(e){return e.title===t})[0]}}function l(){var e='<li class="cate all"><span class="name cate">所有任务</span><span class="undone cate">0</span></li>',t=0;for(var a in M){var n=M[a],i=n.getTasksByStatus("undone").length;e+='<li class="cate"><span class="name cate">'+n.name+'</span><span class="undone cate">'+i+'</span><img class="remove" src="img/icon-minus.png"></li>',t+=i}var s=h(".catelist");s.innerHTML=e,y(s.childNodes[1],"active"),y(s.childNodes[1],"default"),h(".all .undone").innerHTML=t}function c(e){var t=s().filter(function(t){switch(e){case void 0:return!0;case"undone":return t.done===!1;case"done":return t.done===!0}});if(void 0===t[0])h(".tasklist").innerHTML="";else{var a=T(t.map(function(e){return e.date})),n="";for(var i in a){var r=a[i];n+='<ul class="day"><h1 class="date">'+r+"</h1>";var l=t.filter(function(e){return e.date===r});for(var c in l){var o=l[c];n+='<li class="'+(o.done?"done ":"")+'task">'+o.title+"</li>"}n+="</ul>"}h(".tasklist").innerHTML=n,y(h(".tasklist").childNodes[0].childNodes[1],"active")}}function o(){var e=h(".tasklist .active");if(!e)return void B(L.contentOriginal,!1);var t=e.innerHTML,a=S.filter(function(e){return e.title===t})[0];void 0===a?B(L.contentOriginal,!1):(h("#content .title").innerHTML=a.title,h("#content .date").innerHTML=a.date,h("#content .main").innerHTML=a.main,a.done?y(h("#content .title"),"done"):p(h("#content .title"),"done"))}function d(e){var t;switch(!0){case k(e,"cate"):t=h(".catelist");break;case k(e,"task"):t=h(".tasklist");break;case k(e,"status"):t=h(".status-nav")}p(t.getElementsByClassName("active")[0],"active"),y(e,"active")}function u(e){var t=h(".catelist").getElementsByClassName("name");for(var a in t)if(t[a].innerHTML===e)return d(t[a].parentElement),!0;return!1}function v(e){var t=h(".tasklist").getElementsByClassName("task");for(var a in t)if(t[a].innerHTML===e)return d(t[a]),!0;return!1}function m(){var e=JSON.parse(localStorage.getItem("cateCache")),i=JSON.parse(localStorage.getItem("taskCache"));if(null===e){n(new a("默认分类")),n(new a("Work")),n(new a("Social")),n(new a("Trifle"));var s=new t("Date with my GF","2017-02-14","Wait. I ain't got none."),r=new t("Burger King","2017-04-01","Haven't had that for long.");M[0].addTask(s),M[0].addTask(r),s.done=!0;var l=new t("Finish task 0003","2016-04-30","Here is some content."),c=new t("Write report","2016-05-30","He he he.");M[1].addTask(l),M[1].addTask(c);var o=new t("Meet college pals","2016-05-30","And have some beer."),d=new t("Go to Jake's wedding","2016-10-01","How much should it cost me again?");M[2].addTask(o),M[2].addTask(d);var u=new t("Buy new shampoo","2017-02-14","That CLEAR one."),v=new t("Have a haircut","2016-06-01","To celebrate Children's day.");M[3].addTask(u),M[3].addTask(v)}else{var m=[];for(var g in i){var f=i[g],h=new t(f.title,f.date,f.main);h.done=f.done,m.push(h)}S=m;var k=[];for(var g in e){var p=e[g],y=p.tasks,T=new a(p.name);for(var g in y){var b=y[g].title;T.tasks.push(S.filter(function(e){return e.title===b})[0])}k.push(T)}M=k}}function g(){localStorage.setItem("cateCache",JSON.stringify(M)),localStorage.setItem("taskCache",JSON.stringify(S))}function f(){C(),m(),l(),c(),o()}var h=e.$,k=e.hasClass,p=e.removeClass,y=e.addClass,T=e.uniqArray,b=e.trim,N=e.isValidDate,w=e.showInfo,C=e.resizeToWindowSize,B=e.replaceContentHtml,E=e.validateInput,H=e.dateDescending,L=function(){return{isEditing:!1,taskUnderEditing:null,archiveToEdit:"",archiveToDisplay:"",save:function(){var e=h("#content .title").innerHTML;this.archiveToDisplay=h("#content").innerHTML,this.archiveToEdit='<input type="input" class="title editable" placeholder="标题（22个字以内）" maxlength=22 value="'+e+'"><input type="input" class="date editable" placeholder="日期（yyyy-mm-dd格式）" maxlength=10 value="'+h("#content .date").innerHTML+'"><textarea class="main editable" placeholder="正文（500个字以内）" maxlength=500>'+h("#content .main").innerHTML+'</textarea><img class="save" src="img/icon-tick.png"><img class="cancel" src="img/icon-times.png">',this.taskUnderEditing=S.filter(function(t){return t.title===e})[0]},contentWhenAddingNew:'<input type="input" class="title editable" placeholder="标题（22个字以内）" maxlength=22><input type="input" class="date editable" placeholder="日期（yyyy-mm-dd格式）" maxlength=10><textarea class="main editable" placeholder="正文（500个字以内）" maxlength=500></textarea><img class="save" src="img/icon-tick.png"><img class="cancel" src="img/icon-times.png">',contentOriginal:'<h1 class="title">.</h1><h1 class="date">.</h1><p class="main">.</p><img class="mark" src="img/icon-done.png"><img class="edit" src="img/icon-pencil.png">'}}();h.delegateByClassName(".catelist","cate","mouseover",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;k(a,"all")||k(a,"default")||(a.getElementsByClassName("remove")[0].style.display="block")}),h.delegateByClassName(".catelist","cate","mouseout",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;k(a,"all")||k(a,"default")||(a.getElementsByClassName("remove")[0].style.display="none")}),h.delegateByClassName(".catelist","cate","click",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;d(a),d(h(".status.all")),c(),o()}),h.delegateByClassName(".catelist","remove","mouseover",function(e){var t=e.target;t.style.display="block"}),h.delegateByClassName(".catelist","remove","mouseout",function(e){var t=e.target;t.style.display="none"}),h.delegateByClassName(".catelist","remove","click",function(e){var t=e.target,a=t.previousElementSibling.previousElementSibling.innerHTML,n=confirm("将同时删除分类「"+a+"」下的所有任务。继续吗？");if(n===!0){var s=i(a),r=s.getTasksByStatus();for(var d in r)S.splice(S.indexOf(r[d]),1);M.splice(M.indexOf(s),1),l(),c(),o(),g()}}),h.click("#category .add",function(e){var t=prompt("请输入新分类的名字(8个字以内）。");if(null!==t){for(;""===t||t.length>8;)t=prompt("分类名称长度应在1至8个字之间。");return"所有任务"===t?void w("bad","不能给分类起这个名字。_(:зゝ∠)_"):n(new a(t))!==!0?void w("bad","已存在相同名称的分类。"):(w("good","添加分类成功。"),l(),d(h(".catelist").lastChild),c(),o(),g(),void 0)}}),h.delegateByClassName(".status-nav","status","click",function(e){var t=e.target;switch(d(t),!0){case k(t,"all"):c();break;case k(t,"undone"):c("undone");break;case k(t,"done"):c("done")}o()}),h.delegateByClassName(".tasklist","task","click",function(e){var t=e.target;d(t),o()}),h.click("#tasks .add",function(e){return k(h(".cate.all"),"active")?void w("bad","请先选择一个分类。"):(L.isEditing=!1,L.save(),void B(L.contentWhenAddingNew,!0))}),h.delegateByClassName("#content","mark","click",function(e){var t=r();if(void 0===t)return void w("bad","还没添加任务呢。");if(t.done===!0)return void w("bad","这个任务已经完成啦！");var a=t.title,n=h("#category .active").getElementsByClassName("name")[0].innerHTML,i=confirm("将「"+a+"」标记为「已完成」吗？");i===!0&&(t.done=!0,w("good","标记成功。"),g(),l(),u(n),c(),v(a),o())}),h.delegateByClassName("#content","edit","click",function(e){return void 0===r()?void w("bad","还没添加任务呢。"):(L.isEditing=!0,L.save(),void B(L.archiveToEdit,!0))}),h.delegateByClassName("#content","save","click",function(){var e=b(h(".title.editable").value),a=h(".date.editable").value,n=b(h(".main.editable").value);switch(L.isEditing){case!0:if(E(S,!1)){var s=L.taskUnderEditing;s.title=e,s.date=a,s.main=n,w("good","任务修改成功。"),B(L.contentOriginal,!1),c(),v(s.title),g()}break;case!1:if(E(S,!0)){var r=h("#category .active").getElementsByClassName("name")[0].innerHTML;i(r).addTask(new t(e,a,n)),w("good","成功添加任务。"),B(L.contentOriginal,!1),l(),u(r),c(),v(e),g()}}o()}),h.delegateByClassName("#content","cancel","click",function(){var e=confirm("确定退出编辑？");e===!0&&B(L.archiveToDisplay,!1)}),h.delegateByClassName("#content","editable","keyup",function(e){var t=e.target,a=t.value;switch(!0){case k(t,"title"):22===a.length&&w("bad","任务标题不能超过22个字。");break;case k(t,"date"):10!==a.length||N(a)||w("bad","任务日期不符合yyyy-mm-dd格式。");break;case k(t,"main"):500===a.length&&w("bad","任务正文不能超过500个字。")}}),window.onresize=function(){C()},h.click("#title .btn",function(){localStorage.clear(),w("bad","缓存已清理。")});var M=[],S=[];return{init:f}});