function showInfo(e,t){var a="good"===e?$(".notif.good"):$(".notif.bad");a.innerHTML=t,setTimeout(function(){a.innerHTML=""},3e3)}function resizeToWindowSize(){var e=window.innerWidth<=900?900:window.innerWidth,t=window.innerHeight<=600?600:window.innerHeight;$("#wrapper").style.width=e+"px",$("#wrapper").style.height=t+"px",$("#category").style.height=$("#tasks").style.height=t-60+"px",$(".tasklist").style.height=t-140+"px",$("#content").style.width=e-480+"px",$("#content .main").style.height=t-200+"px"}function replaceContentHtml(e,t){switch($("#content").innerHTML=e,t){case!0:$("#cover").style.display="block";break;case!1:$("#cover").style.display="none"}resizeToWindowSize()}function dateDescending(e,t){return e.date.replace("-","")>t.date.replace("-","")?-1:1}function validateInput(e){var t=trim2($("#content .title").value),a=$("#content .date").value,n=trim2($("#content .main").value);if(!t.match(/^.{1,22}$/))return showInfo("bad","任务标题长度应在1至22字之间。"),!1;if(!isValidDate(a))return showInfo("bad","任务日期应为yyyy-mm-dd格式。"),!1;if(!n.match(/^.{1,500}$/))return showInfo("bad","任务正文长度应在1至500字之间。"),!1;if(e===!0){var i=taskLib.some(function(e){return e.title===t});if(i)return showInfo("bad","已存在相同名称的任务。"),!1}return!0}function Task(e,t,a){this.title=e,this.date=t,this.main=a,this.done=!1}function Category(e){this.name=e,this.tasks=[],this.addTask=function(e){var t=e.title,a=taskLib.some(function(e){return e.title===t});return a===!1?(this.tasks.push(e),this.tasks.sort(dateDescending),taskLib.push(e),taskLib.sort(dateDescending),!0):!1},this.getTask=function(e){var t=this.tasks.filter(function(t){return t.title===e})[0];return void 0!==t?t:null},this.getTasksByStatus=function(e){var t=[];switch(e){case void 0:t=this.tasks;break;case"undone":t=this.tasks.filter(function(e){return e.done===!1});break;case"done":t=this.tasks.filter(function(e){return e.done===!0})}return t.sort(dateDescending)},this.getTasksByDate=function(e){return this.tasks.filter(function(t){return t.date===e})}}function addCategory(e){var t=e.name,a=cateLib.some(function(e){return e.name===t});return a===!1?(cateLib.push(e),!0):!1}function getCategoryByCateName(e){var t=cateLib.filter(function(t){return t.name===e})[0];return void 0!==t?t:null}function getTargetTasksArray(){var e=$("#category .active").getElementsByClassName("name")[0].innerHTML;return"所有任务"===e?taskLib:getCategoryByCateName(e).tasks}function getActiveTask(){var e=$(".tasklist .active");if(null!==e){var t=e.innerHTML;return taskLib.filter(function(e){return e.title===t})[0]}}function renderCategoryList(){var e='<li class="cate all"><span class="name cate">所有任务</span><span class="undone cate">0</span></li>',t=0;for(var a in cateLib){var n=cateLib[a],i=n.getTasksByStatus("undone").length;e+='<li class="cate"><span class="name cate">'+n.name+'</span><span class="undone cate">'+i+'</span><img class="remove" src="img/icon-minus.png"></li>',t+=i}var s=$(".catelist");s.innerHTML=e,addClass(s.childNodes[1],"active"),addClass(s.childNodes[1],"default"),$(".all .undone").innerHTML=t}function renderTasksList(e){var t=getTargetTasksArray().filter(function(t){switch(e){case void 0:return!0;case"undone":return t.done===!1;case"done":return t.done===!0}});if(void 0===t[0])$(".tasklist").innerHTML="";else{var a=uniqArrayHASH(t.map(function(e){return e.date})),n="";for(var i in a){var s=a[i];n+='<ul class="day"><h1 class="date">'+s+"</h1>";var r=t.filter(function(e){return e.date===s});for(var o in r){var l=r[o];n+='<li class="'+(l.done?"done ":"")+'task">'+l.title+"</li>"}n+="</ul>"}$(".tasklist").innerHTML=n,addClass($(".tasklist").childNodes[0].childNodes[1],"active")}}function renderTask(){var e=$(".tasklist .active");if(!e)return void replaceContentHtml(contentHtmlUtil.contentOriginal,!1);var t=e.innerHTML,a=taskLib.filter(function(e){return e.title===t})[0];void 0===a?replaceContentHtml(contentHtmlUtil.contentOriginal,!1):($("#content .title").innerHTML=a.title,$("#content .date").innerHTML=a.date,$("#content .main").innerHTML=a.main,a.done?addClass($("#content .title"),"done"):removeClass($("#content .title"),"done"))}function activateTargetLi(e){var t;switch(!0){case hasClass(e,"cate"):t=$(".catelist");break;case hasClass(e,"task"):t=$(".tasklist");break;case hasClass(e,"status"):t=$(".status-nav")}removeClass(t.getElementsByClassName("active")[0],"active"),addClass(e,"active")}function activateTargetCateName(e){var t=$(".catelist").getElementsByClassName("name");for(var a in t)if(t[a].innerHTML===e)return activateTargetLi(t[a].parentElement),!0;return!1}function activateTargetTaskName(e){var t=$(".tasklist").getElementsByClassName("task");for(var a in t)if(t[a].innerHTML===e)return activateTargetLi(t[a]),!0;return!1}function loadFromCache(){var e=JSON.parse(localStorage.getItem("cateCache")),t=JSON.parse(localStorage.getItem("taskCache"));if(null===e){addCategory(new Category("默认分类")),addCategory(new Category("Work")),addCategory(new Category("Social")),addCategory(new Category("Trifle"));var a=new Task("Date with my GF","2017-02-14","Wait. I ain't got none."),n=new Task("Burger King","2017-04-01","Haven't had that for long.");cateLib[0].addTask(a),cateLib[0].addTask(n),a.done=!0;var i=new Task("Finish task 0003","2016-04-30","Here is some content."),s=new Task("Write report","2016-05-30","He he he.");cateLib[1].addTask(i),cateLib[1].addTask(s);var r=new Task("Meet college pals","2016-05-30","And have some beer."),o=new Task("Go to Jake's wedding","2016-10-01","How much should it cost me again?");cateLib[2].addTask(r),cateLib[2].addTask(o);var l=new Task("Buy new shampoo","2017-02-14","That CLEAR one."),c=new Task("Have a haircut","2016-06-01","To celebrate Children's day.");cateLib[3].addTask(l),cateLib[3].addTask(c)}else{var d=[];for(var u in t){var g=t[u],m=new Task(g.title,g.date,g.main);m.done=g.done,d.push(m)}taskLib=d;var v=[];for(var u in e){var h=e[u],k=h.tasks,f=new Category(h.name);for(var u in k){var T=k[u].title;f.tasks.push(taskLib.filter(function(e){return e.title===T})[0])}v.push(f)}cateLib=v}}function saveToCache(){localStorage.setItem("cateCache",JSON.stringify(cateLib)),localStorage.setItem("taskCache",JSON.stringify(taskLib))}var contentHtmlUtil=function(){return{isEditing:!1,taskUnderEditing:null,archiveToEdit:"",archiveToDisplay:"",save:function(){var e=$("#content .title").innerHTML;this.archiveToDisplay=$("#content").innerHTML,this.archiveToEdit='<input type="input" class="title editable" placeholder="标题（22个字以内）" maxlength=22 value="'+e+'"><input type="input" class="date editable" placeholder="日期（yyyy-mm-dd格式）" maxlength=10 value="'+$("#content .date").innerHTML+'"><textarea class="main editable" placeholder="正文（500个字以内）" maxlength=500>'+$("#content .main").innerHTML+'</textarea><img class="save" src="img/icon-tick.png"><img class="cancel" src="img/icon-times.png">',this.taskUnderEditing=taskLib.filter(function(t){return t.title===e})[0]},contentWhenAddingNew:'<input type="input" class="title editable" placeholder="标题（22个字以内）" maxlength=22><input type="input" class="date editable" placeholder="日期（yyyy-mm-dd格式）" maxlength=10><textarea class="main editable" placeholder="正文（500个字以内）" maxlength=500></textarea><img class="save" src="img/icon-tick.png"><img class="cancel" src="img/icon-times.png">',contentOriginal:'<h1 class="title">.</h1><h1 class="date">.</h1><p class="main">.</p><img class="mark" src="img/icon-done.png"><img class="edit" src="img/icon-pencil.png">'}}(),cateLib=[],taskLib=[];$.delegateByClassName(".catelist","cate","mouseover",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;hasClass(a,"all")||hasClass(a,"default")||(a.getElementsByClassName("remove")[0].style.display="block")}),$.delegateByClassName(".catelist","cate","mouseout",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;hasClass(a,"all")||hasClass(a,"default")||(a.getElementsByClassName("remove")[0].style.display="none")}),$.delegateByClassName(".catelist","cate","click",function(e){var t=e.target,a="LI"===t.nodeName?t:t.parentElement;activateTargetLi(a),activateTargetLi($(".status.all")),renderTasksList(),renderTask()}),$.delegateByClassName(".catelist","remove","mouseover",function(e){var t=e.target;t.style.display="block"}),$.delegateByClassName(".catelist","remove","mouseout",function(e){var t=e.target;t.style.display="none"}),$.delegateByClassName(".catelist","remove","click",function(e){var t=e.target,a=t.previousElementSibling.previousElementSibling.innerHTML,n=confirm("将同时删除分类「"+a+"」下的所有任务。继续吗？");if(n===!0){var i=getCategoryByCateName(a),s=i.getTasksByStatus();for(var r in s)taskLib.splice(taskLib.indexOf(s[r]),1);cateLib.splice(cateLib.indexOf(i),1),renderCategoryList(),renderTasksList(),renderTask(),saveToCache()}}),$.click("#category .add",function(e){var t=prompt("请输入新分类的名字(8个字以内）。");if(null!==t){for(;""===t||t.length>8;)t=prompt("分类名称长度应在1至8个字之间。");return"所有任务"===t?void showInfo("bad","不能给分类起这个名字。_(:зゝ∠)_"):addCategory(new Category(t))!==!0?void showInfo("bad","已存在相同名称的分类。"):(showInfo("good","添加分类成功。"),renderCategoryList(),activateTargetLi($(".catelist").lastChild),renderTasksList(),renderTask(),saveToCache(),void 0)}}),$.delegateByClassName(".status-nav","status","click",function(e){var t=e.target;switch(activateTargetLi(t),!0){case hasClass(t,"all"):renderTasksList();break;case hasClass(t,"undone"):renderTasksList("undone");break;case hasClass(t,"done"):renderTasksList("done")}renderTask()}),$.delegateByClassName(".tasklist","task","click",function(e){var t=e.target;activateTargetLi(t),renderTask()}),$.click("#tasks .add",function(e){return hasClass($(".cate.all"),"active")?void showInfo("bad","请先选择一个分类。"):(contentHtmlUtil.isEditing=!1,contentHtmlUtil.save(),void replaceContentHtml(contentHtmlUtil.contentWhenAddingNew,!0))}),$.delegateByClassName("#content","mark","click",function(e){var t=getActiveTask();if(void 0===t)return void showInfo("bad","还没添加任务呢。");if(t.done===!0)return void showInfo("bad","这个任务已经完成啦！");var a=t.title,n=$("#category .active").getElementsByClassName("name")[0].innerHTML,i=confirm("将「"+a+"」标记为「已完成」吗？");i===!0&&(t.done=!0,showInfo("good","标记成功。"),saveToCache(),renderCategoryList(),activateTargetCateName(n),renderTasksList(),activateTargetTaskName(a),renderTask())}),$.delegateByClassName("#content","edit","click",function(e){return void 0===getActiveTask()?void showInfo("bad","还没添加任务呢。"):(contentHtmlUtil.isEditing=!0,contentHtmlUtil.save(),void replaceContentHtml(contentHtmlUtil.archiveToEdit,!0))}),$.delegateByClassName("#content","save","click",function(){var e=trim2($(".title.editable").value),t=$(".date.editable").value,a=trim2($(".main.editable").value);switch(contentHtmlUtil.isEditing){case!0:if(validateInput(!1)){var n=contentHtmlUtil.taskUnderEditing;n.title=e,n.date=t,n.main=a,showInfo("good","任务修改成功。"),replaceContentHtml(contentHtmlUtil.contentOriginal,!1),renderTasksList(),activateTargetTaskName(n.title),saveToCache()}break;case!1:if(validateInput(!0)){var i=$("#category .active").getElementsByClassName("name")[0].innerHTML;getCategoryByCateName(i).addTask(new Task(e,t,a)),showInfo("good","成功添加任务。"),replaceContentHtml(contentHtmlUtil.contentOriginal,!1),renderCategoryList(),activateTargetCateName(i),renderTasksList(),activateTargetTaskName(e),saveToCache()}}renderTask()}),$.delegateByClassName("#content","cancel","click",function(){var e=confirm("确定退出编辑？");e===!0&&replaceContentHtml(contentHtmlUtil.archiveToDisplay,!1)}),$.delegateByClassName("#content","editable","keyup",function(e){var t=e.target,a=t.value;switch(!0){case hasClass(t,"title"):22===a.length&&showInfo("bad","任务标题不能超过22个字。");break;case hasClass(t,"date"):10!==a.length||isValidDate(a)||showInfo("bad","任务日期不符合yyyy-mm-dd格式。");break;case hasClass(t,"main"):500===a.length&&showInfo("bad","任务正文不能超过500个字。")}}),window.onload=function(){resizeToWindowSize(),loadFromCache(),renderCategoryList(),renderTasksList(),renderTask(),$.click("#title .btn",function(){localStorage.clear(),showInfo("bad","缓存已清理。")})},window.onresize=function(){resizeToWindowSize()};